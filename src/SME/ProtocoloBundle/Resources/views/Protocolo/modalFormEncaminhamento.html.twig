<div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Encaminhamento - Protocolo {{protocolo.protocolo}}</h4>
    </div>
    <div class="modal-body">
        <p> <strong>Histórico de encaminhamentos</strong> </p>
        <table class="table table-striped table-hover">
            <tr>
                <th>Data</th>
                <th>Encaminhado por</th>
                <th>Recebido por</th>
                <th>Motivo / Observação</th>
            </tr>
            {% for encaminhamento in protocolo.encaminhamentos %}
                <tr>
                    <td>{{encaminhamento.dataCadastro|date('d/m/Y')}}</td>
                    <td>{{encaminhamento.pessoaEncaminha.nome}}</td>
                    <td>{{encaminhamento.pessoaRecebe.nome}}</td>
                    <td>
                        {% if encaminhamento.motivo %} 
                            {{encaminhamento.motivo.descricao}} 
                        {% else %} 
                            {{encaminhamento.observacao}} 
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td class="text-center" colspan="4">Nenhum encaminhamento realizado ainda</td>
                </tr>
            {% endfor %}
        </table>
        <form id="formEncaminhamento">
            <table class="table table-striped table-hover">
                <tr>
                    <th>Encaminhar para</th>
                    <td>
                        <select id="pessoaRecebe" name="pessoaRecebe" class="form-control" required="true">
                            {% for usuario in usuarios %}
                                {% if usuario.pessoa %}
                                    <option value="{{usuario.pessoa.id}}">{{usuario.pessoa.nome}}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Motivo</th>
                    <td>
                        <select id="motivo" name="motivo" class="form-control">
                            <option></option>
                            {% for motivo in motivos %}
                                <option value="{{motivo.id}}">{{motivo.descricao}}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Alterar situação para</th>
                    <td>
                        <select id="situacao" name="situacao" class="form-control" required="true">
                            {% for situacao in situacoes %}
                                {% if situacao.terminal %}
                                    <option {% if protocolo.situacao.id == situacao.id %}selected="true"{% endif %} class="terminal text-warning" value="{{situacao.id}}"> 
                                        {{situacao.nome}}
                                    </option>
                                {% else %}
                                    <option {% if protocolo.situacao.id == situacao.id %}selected="true"{% endif %} value="{{situacao.id}}">
                                        {{situacao.nome}}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Observação</th>
                    <td>
                        <textarea id="observacao" name="observacao" class="form-control form-control-static" rows="5">{{protocolo.observacao|trim}}</textarea>
                    </td>
                </tr>
            </table>
            <div class="row">
                <div class="col-lg-12">
                    <button id="btnEncaminhar" type="button" class="btn btn-primary btn-block">Encaminhar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
    $("#btnEncaminhar").click(function() {
        $.ajax({
            type: "POST",
            url: "{{url('protocolo_admin_encaminhar', {'protocolo': protocolo.id})}}",
            data: $("#formEncaminhamento, #formPesquisaProtocolo").serialize(),
            success: function(retorno) {
                $("#divListaProtocolos").html(retorno);
            }
        });
        $("#modalDialog").modal('toggle');
    });
</script>
